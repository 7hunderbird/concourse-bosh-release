#!/bin/bash
# vim: ft=sh

<%
  def seconds(duration)
    case duration
    when /^(\d+)s?$/
      $1.to_i
    when /^(\d+)m$/
      $1.to_i * 60
    when /^(\d+)h$/
      $1.to_i * 60 * 60
    else
      raise "malformed duration: %s", duration
    end
  end
%>

set -e

RUN_DIR=/var/vcap/sys/run/worker
LOG_DIR=/var/vcap/sys/log/worker

mkdir -p $RUN_DIR
chown -R vcap:vcap $RUN_DIR

mkdir -p $LOG_DIR
chown -R vcap:vcap $LOG_DIR

exec 3>&1 # make stdout available as fd 3 for the drain result
exec 1>>$LOG_DIR/drain.stdout.log
exec 2>>$LOG_DIR/drain.stderr.log

if [ "$1" == "job_shutdown" ]; then
  cmd="retire-worker"
else
  cmd="land-worker"
fi

/var/vcap/jobs/worker/bin/pre_start

source /var/vcap/jobs/worker/config/env.sh

chpst -u vcap:vcap /var/vcap/packages/concourse/bin/concourse \
  $cmd

start-stop-daemon \
  --stop \
  --oknodo \
  --pidfile $RUN_DIR/worker.pid \
  --retry 0/<%= seconds(p("drain_timeout")) %>/TERM/60/KILL

echo 0 >&3
