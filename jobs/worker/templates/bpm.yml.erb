---
<%
  worker_gateway_addrs = nil

  if_p("worker_gateway.hosts") do |hosts|
    worker_gateway_addrs = hosts
  end

  if worker_gateway_addrs.nil?
    web = link("web")
    port = web.p("worker_gateway.bind_port")
    worker_gateway_addrs = web.instances.collect do |instance|
      "#{instance.address}:#{port}"
    end
  end

  name_prefix = spec.id.split("-")[0]
%>

processes:
- name: worker
  executable: /var/vcap/packages/concourse/bin/concourse
  args: [worker]

  unsafe:
    privileged: true
    unrestricted_volumes:
    - path: /var/run
      writable: true
      mount_only: true


  # ephemeral_disk: true
  additional_volumes:
  - path: /var/vcap/data/worker/work
    writable: true

  hooks:
    pre_start: /var/vcap/jobs/worker/bin/pre_start

  env:
    # XXX: put instance guid in prefix
    # CONCOURSE_NAME:

    CONCOURSE_WORK_DIR: /var/vcap/data/worker/work

    CONCOURSE_TSA_HOST: <%= worker_gateway_addrs.join(",").to_json %>

<% if p("worker_gateway.registration_mode") == "direct" -%>
    CONCOURSE_PEER_IP: <%= spec.address %>
    CONCOURSE_BIND_IP: 0.0.0.0
    CONCOURSE_BAGGAGECLAIM_BIND_IP: 0.0.0.0
<% end -%>

<%
  unless p("worker_gateway.hosts", nil)
    if_link("web") do |link|
      port = link.p("worker_gateway.bind_port")
-%>
    CONCOURSE_TSA_HOST: <%= link.instances.collect { |i| "#{i.address}:#{port}" }.join(",").to_json %>
    CONCOURSE_TSA_PUBLIC_KEY: /var/vcap/jobs/worker/config/worker_gateway_host_key.pub
<%
    end
  end
-%>

<%
  # vim: ft=eruby

  def env_flag(v)
    case v
    when Array
      v.join(",").to_json
    when Hash
      v.collect { |k, v| "#{k}:#{v}" }.join(",").to_json
    else
      v.to_json
    end
  end

  def env_file_flag(v, env)
    case v
    when Array
      v.collect.with_index { |v, i| "/var/vcap/jobs/worker/config/env/#{env}_#{i}" }.join(",").to_json
    when Hash
      v.collect { |k, v| "#{k}:/var/vcap/jobs/worker/config/env/#{env}_#{k}" }.join(",").to_json
    else
      "/var/vcap/jobs/worker/config/env/#{env}".to_json
    end
  end
-%>
<% if_p("http_proxy_url") do |v| -%>
    http_proxy: <%= env_flag(v) %>
<% end -%>

<% if_p("https_proxy_url") do |v| -%>
    https_proxy: <%= env_flag(v) %>
<% end -%>

<% if_p("worker_gateway.hosts") do |v| -%>
    CONCOURSE_TSA_HOST: <%= env_flag(v) %>
<% end -%>

<% if_p("baggageclaim.driver") do |v| -%>
    CONCOURSE_BAGGAGECLAIM_DRIVER: <%= env_flag(v) %>
<% end -%>

<% if_p("no_proxy") do |v| -%>
    no_proxy: <%= env_flag(v) %>
<% end -%>

<% if_p("ephemeral") do |v| -%>
    CONCOURSE_EPHEMERAL: <%= env_flag(v) %>
<% end -%>

<% if_p("baggageclaim.bind_port") do |v| -%>
    CONCOURSE_BAGGAGECLAIM_BIND_PORT: <%= env_flag(v) %>
<% end -%>

<% if_p("log_level") do |v| -%>
    CONCOURSE_LOG_LEVEL: <%= env_flag(v) %>
<% end -%>

<% if_p("team") do |v| -%>
    CONCOURSE_TEAM: <%= env_flag(v) %>
<% end -%>

<% if_p("tags") do |v| -%>
    CONCOURSE_TAG: <%= env_flag(v) %>
<% end -%>

<% if_p("certs_path") do |v| -%>
    CONCOURSE_CERTS_DIR: <%= env_flag(v) %>
<% end -%>

<% if_p("worker_gateway.host_public_key") do |v| -%>
    CONCOURSE_TSA_PUBLIC_KEY: <%= env_file_flag(v, "CONCOURSE_TSA_PUBLIC_KEY") %>
<% end -%>

<% if_p("worker_gateway.worker_key.private_key") do |v| -%>
    CONCOURSE_TSA_WORKER_PRIVATE_KEY: <%= env_file_flag(v, "CONCOURSE_TSA_WORKER_PRIVATE_KEY") %>
<% end -%>

