---
name: worker

description: >
  The ground crew registers a Garden worker with the ATC on an interval,
  advertises supported resource types, and cleans up ephemeral containers on
  shutdown.

templates:
  # drain.erb: bin/drain
  bpm.yml.erb: config/bpm.yml
  worker_gateway_host_key.pub.erb: config/worker_gateway_host_key.pub
  worker_key.erb: config/worker_key

packages:
- concourse

consumes:
- name: web
  type: web
  optional: true

properties:
  log_level: # done
    description: |
      The log level for the worker. When set to debug, you'll see a lot more
      information.
    default: info

  team: # done
    description: |
      Register the worker for a single team.

      If not specified, the worker will be shared across all teams.

  tags: # done
    description: |
      An array of tags to advertise for each worker.
    default: []

  http_proxy_url: # done
    description: |
      Proxy to use for outgoing http requests from containers.

  https_proxy_url: # done
    description: |
      Proxy to use for outgoing https requests from containers.

  no_proxy: # done
    description: |
      A list domains and IPs with optional port for which the proxy should be bypassed, e.g. [localhost, 127.0.0.1, example.com, domain.com:8080]
    default: []

  certs_path: # done
    description: |
      A path to a directory on the instance to create the resource certificates volume from.
    default: "/etc/ssl/certs"

  drain_timeout: # done
    description: |
      Maximum wait time in Go duration format (1m = 1 minute) for worker drain
      to be finished. Only applies when worker is getting shutdown.

      If not specified, it will be indefinite.

  ephemeral: # done
    description: |
      If set, the worker will immediately disappear upon stalling.
    default: false

  worker_gateway.host: # done
    description: |
      IP or DNS address of the TSA server to register with.

      If not specified, the `web` link is used.

  worker_gateway.port: # done
    description: |
      Port of the TSA server to register with.

      Only used when `worker_gateway.host` is also specified. Otherwise the
      port is autodiscovered via the `web` link.
    default: 2222

  worker_gateway.host_public_key: # done
    description: >
      Public key to verify for the TSA server.

      If not specified, the `web` link is used.
    example: 'ssh-rsa ...'

  worker_gateway.worker_key: # done
    type: ssh
    description: |
      SSH key to use when authenticating with the TSA.
    example:
      private_key: |
        -----BEGIN RSA PRIVATE KEY-----
        ...
        -----END RSA PRIVATE KEY-----
      public_key: 'ssh-rsa ...'

  worker_gateway.registration_mode: # done
    description: |
      The registration 'mode' (direct, or forward), to use when registering the
      worker with the ATC.
      If "forward" is specified, the worker's Baggageclaim and Garden address
      will be forwarded through SSH to the TSA.

      If "direct" is specified, the worker will be registered directly without
      forwarding over SSH.
    default: direct

  worker_gateway.registration_rebalance_time: # XXX
    description: |
      For forwarded mode only. The interval on which a new connection will be
      created by the worker, also acts as the idle timeout time of the stale
      connections. A value of 0 would mean that the Worker will not create
      additional connections.
    default: 0s

  baggageclaim.driver:
    description: |
      Driver to use for the volume store. One of detect, overlay, btrfs, or naive.
    default: detect

  baggageclaim.bind_ip:
    description: |
      IP address on which Baggageclaim should listen for HTTP traffic.
    default: 0.0.0.0

  baggageclaim.bind_port:
    description: |
      Port on which Baggageclaim should listen for HTTP traffic.
    default: 7788
